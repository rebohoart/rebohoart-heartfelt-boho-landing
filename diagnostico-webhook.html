<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagn√≥stico Webhook n8n - Formato de Dados</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 900px;
      margin: 30px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    .format-option {
      background: #f8f9fa;
      border: 2px solid #dee2e6;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .format-option:hover {
      border-color: #4CAF50;
      background: #f0f9f0;
    }
    .format-option.selected {
      border-color: #4CAF50;
      background: #e8f5e9;
    }
    .format-title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 5px;
      color: #333;
    }
    .format-desc {
      font-size: 13px;
      color: #666;
      margin-bottom: 8px;
    }
    .format-example {
      background: white;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 11px;
      color: #495057;
      overflow-x: auto;
    }
    input[type="file"] {
      display: block;
      width: 100%;
      padding: 10px;
      border: 2px dashed #ccc;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 20px;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
      width: 100%;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .preview {
      margin-top: 15px;
      max-width: 200px;
    }
    .preview img {
      max-width: 100%;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    #result {
      margin-top: 30px;
      padding: 20px;
      border-radius: 4px;
      display: none;
    }
    .success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    .info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
      margin-top: 10px;
      white-space: pre-wrap;
    }
    .loader {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Diagn√≥stico de Formato do Webhook</h1>
    <p class="subtitle">Teste diferentes formatos de payload para descobrir o que o n8n espera</p>

    <div style="margin-bottom: 30px;">
      <label for="imageFile" style="display: block; font-weight: 600; margin-bottom: 10px;">
        Selecione uma imagem de teste:
      </label>
      <input type="file" id="imageFile" accept="image/*">
      <div id="preview" class="preview"></div>
    </div>

    <div style="margin-bottom: 20px;">
      <label style="display: block; font-weight: 600; margin-bottom: 10px;">
        Escolha o formato de payload para testar:
      </label>

      <div class="format-option selected" data-format="1">
        <div class="format-title">Formato 1: Base64 sem prefixo (atual)</div>
        <div class="format-desc">String base64 pura, sem "data:image/...;base64,"</div>
        <div class="format-example">{ "image": "iVBORw0KGgo...", "filename": "test.jpg", "mimeType": "image/jpeg" }</div>
      </div>

      <div class="format-option" data-format="2">
        <div class="format-title">Formato 2: Data URI completo</div>
        <div class="format-desc">String base64 com prefixo completo</div>
        <div class="format-example">{ "image": "data:image/jpeg;base64,iVBORw0KGgo..." }</div>
      </div>

      <div class="format-option" data-format="3">
        <div class="format-title">Formato 3: Campo "file"</div>
        <div class="format-desc">Pode esperar o campo com nome diferente</div>
        <div class="format-example">{ "file": "iVBORw0KGgo...", "filename": "test.jpg" }</div>
      </div>

      <div class="format-option" data-format="4">
        <div class="format-title">Formato 4: Data URI no campo "file"</div>
        <div class="format-desc">Combina√ß√£o de formato 2 + 3</div>
        <div class="format-example">{ "file": "data:image/jpeg;base64,iVBORw0KGgo..." }</div>
      </div>

      <div class="format-option" data-format="5">
        <div class="format-title">Formato 5: Estrutura aninhada</div>
        <div class="format-desc">Pode esperar dados dentro de um objeto "body" ou "data"</div>
        <div class="format-example">{ "body": { "image": "iVBORw0KGgo...", "filename": "test.jpg" } }</div>
      </div>

      <div class="format-option" data-format="6">
        <div class="format-title">Formato 6: Campo "imageData"</div>
        <div class="format-desc">Nome de campo alternativo comum</div>
        <div class="format-example">{ "imageData": "data:image/jpeg;base64,iVBORw0KGgo..." }</div>
      </div>
    </div>

    <button onclick="testFormat()" id="testBtn">
      üöÄ Testar Formato Selecionado
    </button>

    <div id="result"></div>
  </div>

  <script>
    const WEBHOOK_URL = "https://vibecodingc1.app.n8n.cloud/webhook-test/generate-from-upload";
    let selectedFormat = 1;
    let currentFile = null;

    // Sele√ß√£o de formato
    document.querySelectorAll('.format-option').forEach(option => {
      option.addEventListener('click', () => {
        document.querySelectorAll('.format-option').forEach(o => o.classList.remove('selected'));
        option.classList.add('selected');
        selectedFormat = parseInt(option.dataset.format);
      });
    });

    // Preview da imagem
    document.getElementById('imageFile').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        currentFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('preview').innerHTML = `
            <p style="font-size: 12px; color: #666; margin-bottom: 5px;">
              ${file.name} (${(file.size / 1024).toFixed(1)} KB)
            </p>
            <img src="${e.target.result}" alt="Preview">
          `;
        };
        reader.readAsDataURL(file);
      }
    });

    async function testFormat() {
      if (!currentFile) {
        showResult('error', '‚ùå Erro', 'Por favor, selecione uma imagem primeiro.');
        return;
      }

      const testBtn = document.getElementById('testBtn');
      testBtn.disabled = true;
      testBtn.innerHTML = '<span class="loader"></span> Testando formato ' + selectedFormat + '...';

      showResult('info', '‚è≥ Testando...', `Enviando payload no Formato ${selectedFormat}...`);

      try {
        const base64 = await fileToBase64(currentFile);
        const dataUri = await fileToDataUri(currentFile);

        let payload;
        let formatDescription;

        switch(selectedFormat) {
          case 1:
            payload = {
              image: base64,
              filename: currentFile.name,
              mimeType: currentFile.type,
              timestamp: new Date().toISOString()
            };
            formatDescription = "Base64 sem prefixo no campo 'image'";
            break;

          case 2:
            payload = {
              image: dataUri,
              filename: currentFile.name,
              mimeType: currentFile.type
            };
            formatDescription = "Data URI completo no campo 'image'";
            break;

          case 3:
            payload = {
              file: base64,
              filename: currentFile.name,
              mimeType: currentFile.type
            };
            formatDescription = "Base64 sem prefixo no campo 'file'";
            break;

          case 4:
            payload = {
              file: dataUri,
              filename: currentFile.name,
              mimeType: currentFile.type
            };
            formatDescription = "Data URI completo no campo 'file'";
            break;

          case 5:
            payload = {
              body: {
                image: base64,
                filename: currentFile.name,
                mimeType: currentFile.type
              }
            };
            formatDescription = "Base64 dentro de objeto 'body'";
            break;

          case 6:
            payload = {
              imageData: dataUri,
              filename: currentFile.name,
              mimeType: currentFile.type
            };
            formatDescription = "Data URI no campo 'imageData'";
            break;
        }

        console.log(`üß™ Testando Formato ${selectedFormat}:`, formatDescription);
        console.log('üì§ Payload:', { ...payload, image: '[BASE64_TRUNCATED]', file: '[BASE64_TRUNCATED]', imageData: '[BASE64_TRUNCATED]' });

        const startTime = Date.now();
        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });

        const elapsedTime = Date.now() - startTime;
        const responseText = await response.text();

        console.log('üì• Resposta:', {
          status: response.status,
          contentType: response.headers.get('content-type'),
          body: responseText
        });

        let data;
        try {
          data = JSON.parse(responseText);
        } catch (e) {
          data = { raw: responseText };
        }

        if (!response.ok) {
          showResult('error', `‚ùå Formato ${selectedFormat} Falhou`, `
            <strong>${formatDescription}</strong>
            <p>Status: ${response.status} ${response.statusText}</p>
            <p>Tempo: ${elapsedTime}ms</p>
            <p><strong>Resposta do servidor:</strong></p>
            <pre>${responseText}</pre>
            <p style="margin-top: 15px;">üí° Tente outro formato acima</p>
          `);
        } else {
          const imageUrl = data.image_url || data.url || data.image || data.output;

          showResult('success', `‚úÖ Formato ${selectedFormat} Funcionou!`, `
            <strong>${formatDescription}</strong>
            <p>‚úÖ Status: ${response.status}</p>
            <p>‚è±Ô∏è Tempo: ${elapsedTime}ms</p>
            ${imageUrl ? `
              <p><strong>URL da imagem:</strong></p>
              <input type="text" value="${imageUrl}" readonly style="width: 100%; padding: 8px; margin-top: 5px; font-size: 11px; border: 1px solid #ccc; border-radius: 4px;">
              <div style="margin-top: 15px;">
                <img src="${imageUrl}" alt="Resultado" style="max-width: 100%; border-radius: 4px; border: 1px solid #ddd;">
              </div>
            ` : ''}
            <p><strong>Resposta completa:</strong></p>
            <pre>${JSON.stringify(data, null, 2)}</pre>
            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
              <strong>‚ú® Este √© o formato correto!</strong><br>
              Use este formato no c√≥digo do AIImageGenerator.tsx
            </div>
          `);
        }

      } catch (error) {
        console.error('‚ùå Erro:', error);
        showResult('error', '‚ùå Erro na Requisi√ß√£o', `
          <strong>Falha ao conectar com o webhook</strong>
          <p>${error.message}</p>
        `);
      } finally {
        testBtn.disabled = false;
        testBtn.innerHTML = 'üöÄ Testar Formato Selecionado';
      }
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64String = reader.result.split(',')[1];
          resolve(base64String);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function fileToDataUri(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          resolve(reader.result);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function showResult(type, title, message) {
      const result = document.getElementById('result');
      result.className = type;
      result.innerHTML = `
        <h3 style="margin-top: 0;">${title}</h3>
        <div>${message}</div>
      `;
      result.style.display = 'block';
      result.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  </script>
</body>
</html>
